#!/bin/bash

##sharutils asennettu?
shar=$(sudo dpkg-query -l |grep sharutils)
if [[ ${#shar} == 0 ]];then echo Asennetaan sharutils && sudo apt update && sudo apt install -y sharutils; fi

##tarkastetaan jo asennetut ominaisuudet:
k1=$(sudo dpkg-query -l |grep konttiraspi-mesh-client)
if [[ ${#k1} -gt 0 ]];then k1="on"; else k1="off"; fi
k2=$(sudo dpkg-query -l |grep konttiraspi-mesh-gateway)
if [[ ${#k2} -gt 0 ]];then k2="on"; else k2="off"; fi
k3=$(sudo dpkg-query -l |grep konttiraspi-sahkomittari-client)
if [[ ${#k3} -gt 0 ]];then k3="on"; else k3="off"; fi
k4=$(sudo dpkg-query -l |grep konttiraspi-sahkomittari-server)
if [[ ${#k4} -gt 0 ]];then k4="on"; else k4="off"; fi


cmd=(dialog --separate-output --checklist "valitse konttiraspi-system lisäksi asennettavat palvelut:" 22 76 16)
options=(1 "konttiraspi-mesh-client" $k1
         2 "konttiraspi-mesh-gateway" $k2
         3 "konttiraspi-sahkomittari-client" $k3
         4 "konttiraspi-sahkomittari-server" $k4)
choices=$("${cmd[@]}" "${options[@]}" 2>&1 >/dev/tty)
okcancel=$?
clear
if [[ $okcancel != 0 ]]; then
    echo Peruuta
    exit
fi
for choice in $choices
do
    case $choice in
        1)
            a1=1
            ;;
        2)
            a2=1
            ;;
        3)
            a3=1
            ;;
        4)
            a4=1
            ;;
    esac
done
echo asennetaan konttiraspi-system
sudo dpkg -i konttiraspi-system.deb

if [[ $a1 == 1 ]]; then
    echo asennetaan konttiraspi-mesh-client
    sudo dpkg -i konttiraspi-mesh-client.deb
else
    if [[ "$k1" == "on" ]]; then
        echo poistetaan konttiraspi-mesh-client
        sudo dpkg -r konttiraspi-mesh-client
    fi
fi

if [[ $a2 == 1 ]]; then
    echo asennetaan konttiraspi-mesh-gateway
    sudo dpkg -i konttiraspi-mesh-gateway.deb
else
    if [[ "$k2" == "on" ]]; then
        echo poistetaan konttiraspi-mesh-gateway
        sudo dpkg -r konttiraspi-mesh-gateway
    fi
fi


if [[ $a3 == 1 ]]; then
    echo asennetaan konttiraspi-sahkomittari-client
    sudo dpkg -i konttiraspi-sahkomittari-client.deb
else
    if [[ "$k3" == "on" ]]; then
        echo poistetaan konttiraspi-sahkomittari-client
        sudo dpkg -r konttiraspi-sahkomittari-client
    fi
fi

if [[ $a4 == 1 ]]; then
    echo asennetaan konttiraspi-sahkomittari-server
    sudo dpkg -i konttiraspi-sahkomittari-server.deb
else
    if [[ "$k4" == "on" ]]; then
        echo poistetaan konttiraspi-sahkomittari-server
        sudo dpkg -r konttiraspi-sahkomittari-server
    fi
fi


#-------------------------------------------------------------------------
### kirjoitetaan konffitiedosto ####
function konffi {
sudo tee /boot/asetukset.txt >/dev/null << END
## system
#system_updateserver=http://0.0.0.0/update.txt #Automaattiset päivitykset !HUOM EI TUOTANTOKÄYTTÖÖN!

## MESH-asetukset *Client *Gateway
mesh_type=gateway #client|gateway|none *CG
mesh_ip=192.168.234.123 #Tämän laitteen mesh ip *CG
mesh_name=fo-t-raspi333 #Tämän laitteen nimi mesh-verkossa *CG
mesh_gateway=192.168.234.1 #Gatewayn ip *C
mesh_broadcast=192.168.243.255 # *CG
mesh_mhz=2462 #Taajuus jolle mesh-verkko luodaan *CG
mesh_netname=mesh #Mesh-verkon nimi *CG
mesh_country=XX #Mesh-verkon maa. käytä XX jo wifiteholla tehty tietokanta 2 watille *CG
mesh_txpower=30 #Lähetysteho *CG
mesh_device=wlan1 #Wifi-laite, jota mesh käyttää *CG
mesh_mtu=1500 # *CGmesg_mtu=1500
## batnaapuri-asetukset *Client *Server
batnaapuri_server=http://192.168.234.1:8000 #batnaapuri-palvelin *C
batnaapuri_portti=8000 #palvellaan batnaapuri-serveriä tässä portissa *S

## Sähkömittari-asetukset *Client *Server
sm_type=client #server|client *SC
sm_host=palvelin=ws://192.168.4.222:8888/ #Otetaan yhteyttä tähän sähkömittari-palvelimeen kun tämä laite on *C
sm_serial=/dev/ttyUSB0 #sarjaportti jossa arduino kiinni *C
sm_imp=1000 #sahkomittari antaa impulsseja per kwh *C
sm_pulssipysyva=/opt/konttiraspi/sahkomittari-client/pulssi #Tähän tiedostoon tallennetaan pysyvä pulssilukema *C
sm_alive=30 #Lähetetään nn sekunnin välein alive-viesti, jos muuta lähetetävää ei ole *C
sm_tallennapulssisek=600 #Pulssilukema kirjoitetaan nn sekunnin välein. *C
sm_maxtiheys=3 #lähetetään enintään näin monen sekunnin välein lukemia palvelimelle *C
#sm_dhtpin=4 #Lämpömittari raspin tässä pinnissä *C
END

}
### varmistetaan onko koffi jo olemassa ###
if [ ! -f "/boot/asetukset.txt" ]; then
    dialog --defaultno --yesno "Asetustiedostoa ei löydy. Kirjoitetaanko mallitiedosto?" 22 76
    okcancel=$?
    clear
    if [[ "$okcancel" == "0" ]]; then
        konffi
        dialog --msgbox "Asetustiedosto /boot/asetukset.txt on luotu. Muista muokata se!" 22 76 && clear
    fi
fi

dialog --msgbox "Asennus on valmis ja reboot on suositeltavaa tehdä nyt!" 22 76 && clear

