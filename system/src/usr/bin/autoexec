#!/bin/bash
whoami >>/tmp/autoexec.txt
date >>/tmp/autoexec.txt

### lataa asetukset muistiin ###
. /boot/asetukset.txt


### mesh client ###
if [[ "$mesh_type" == "client" ]]; then
    echo mesh  client  >>/tmp/autoexec.txt
    /opt/konttiraspi/mesh-client/meshclient up &
fi

### mesh gateway ###
if [[ "$mesh_type" == "gateway" ]]; then
    echo mesh  gateway  >>/tmp/autoexec.txt
    /opt/konttiraspi/mesh-gateway/meshgateway &
fi

### sähkömittari server ###
if [[ "$sahkomittari_type" == "server" ]]; then
    echo sähkömittari server  >>/tmp/autoexec.txt
    /opt/konttiraspi/sahkomittari-server/sahkomittari-server.py &
fi

### sähkömittari client ###
if [[ "$sahkomittari_type" == "client" ]]; then
    echo sähkömittari client otetaan yhteys kohteeseen $sahkomittari_host  >>/tmp/autoexec.txt
    /opt/konttiraspi/sahkomittari-client/raspisahkomittari.py &
fi

echo mesh-ip $mesh_ip  >>/tmp/autoexec.txt

while true; do #Tarkistetaan päivitykset palvelimelta
    hh=$(date +%H)
    if [[ $hh != $viim ]]; then
        if [[ ! -z "$system_updateserver" ]];then
            echo tark paiv $system_updateserver
            paiv=$(wget "$system_updateserver/paivitys.txt" -O - 2>/dev/null)
            nykyinen=$(cat /opt/konttiraspi/versio 2>/dev/null)
            if [[ $paiv -gt $nykyinen ]]; then
                echo on uudempi LADATAAN! >>/tmp/autoexec.txt
                wget "$system_updateserver/paivitys.bash" -O paivitys.bash 2>/dev/null
                bash paivitys.bash >>/tmp/autoexec.txt
                rm paivitys.bash
                echo $paiv > /opt/konttiraspi/versio
            fi
        fi
        viim=$hh
    fi
    sleep 10
done

